<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Just Magazzino</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Stili personalizzati */
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        /* 1. SPLASH SCREEN MODIFICATA: Rimosso il pulsante sovrapposto, l'intera area è cliccabile */
        .splash-screen { background: url('background.png') no-repeat center center; background-size: cover; cursor: pointer; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        /* Nasconde le frecce nei campi numero */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden select-none">

<div id="app" class="h-full flex flex-col">

    <div v-if="currentSection === 'splash'" @click="enterApp" class="splash-screen absolute inset-0 z-50">
    </div>

    <header v-else class="bg-white shadow-sm pt-12 pb-4 px-4 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-blue-800 capitalize">{{ currentSection }}</h1>
        <div class="text-sm text-gray-500">{{ totalItemsInStock }} Pz Totali</div>
    </header>

    <main v-if="currentSection !== 'splash'" class="flex-1 overflow-y-auto p-4 safe-area-bottom pb-24">
        
        <div v-if="currentSection === 'Articoli'">
            <button @click="openNewProductModal" class="w-full bg-blue-600 text-white py-3 rounded-xl shadow-lg mb-4 font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus"></i> Aggiungi Nuovo Prodotto
            </button>

            <div class="mb-4 sticky top-0 bg-gray-50 pt-2 pb-2 z-10">
                <input v-model="searchQuery" placeholder="Cerca prodotto..." class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div v-for="(products, category) in filteredProducts" :key="category" class="mb-6">
                <h2 class="text-blue-600 font-bold mb-2 uppercase text-xs tracking-wider border-b pb-1">{{ category }}</h2>
                <div v-for="prod in products" :key="prod.id" class="bg-white p-3 rounded-lg shadow-sm mb-2 flex items-center gap-3">
                    <img :src="prod.img" class="w-12 h-12 object-cover rounded-md bg-gray-100 border" @error="imageError">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800 leading-tight">{{ prod.name }}</h3>
                        <p class="text-xs text-gray-500">{{ prod.capacity }} {{ prod.unit }} - {{ prod.price.toFixed(2) }} €</p>
                    </div>
                    <button @click="editProduct(prod)" class="text-gray-400 hover:text-blue-500 p-2"><i class="fa-solid fa-pencil"></i></button>
                </div>
            </div>
            
            <div v-if="editingProduct" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl p-6 w-full max-w-sm overflow-y-auto max-h-[90vh]">
                    <h3 class="font-bold mb-4 text-lg">{{ isNewProduct ? 'Nuovo Prodotto' : 'Modifica Prodotto' }}</h3>
                    
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1 font-bold">Nome Prodotto</label>
                        <input v-model="editingProduct.name" class="w-full border p-2 rounded" placeholder="Es. Bagno Purificante">
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1 font-bold">Categoria</label>
                        <input v-model="editingProduct.cat" class="w-full border p-2 rounded" placeholder="Es. Bagni Caldi ed Essenze" list="category-list">
                        <datalist id="category-list">
                            <option v-for="cat in uniqueCategories" :value="cat"></option>
                        </datalist>
                        <p class="text-[10px] text-gray-400 mt-1">Scrivi una nuova categoria o scegline una esistente.</p>
                    </div>

                    <div class="flex gap-3 mb-3">
                        <div class="w-2/3">
                            <label class="block text-xs text-gray-500 mb-1 font-bold">Capacità</label>
                            <input v-model.number="editingProduct.capacity" type="number" class="w-full border p-2 rounded" placeholder="Es. 250">
                        </div>
                        <div class="w-1/3">
                            <label class="block text-xs text-gray-500 mb-1 font-bold">Unità</label>
                            <select v-model="editingProduct.unit" class="w-full border p-2 rounded bg-white">
                                <option value="ml">ml</option>
                                <option value="gr">gr</option>
                                <option value="pz">pz</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 mb-1 font-bold">Prezzo</label>
                        <div class="relative">
                            <input v-model.number="editingProduct.price" type="number" step="0.01" class="w-full border p-2 rounded pr-8" placeholder="Es. 23.00">
                            <span class="absolute right-3 top-2 text-gray-500 font-bold">€</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-500 mb-1 font-bold">URL Immagine <i class="fa-solid fa-link ml-1"></i></label>
                        <input v-model="editingProduct.img" class="w-full border p-2 rounded text-xs text-blue-600" placeholder="Incolla qui il link dell'immagine">
                        <div v-if="editingProduct.img" class="mt-2 flex justify-center bg-gray-50 p-2 rounded border border-dashed">
                             <img :src="editingProduct.img" class="h-20 object-contain" @error="imageError">
                        </div>
                    </div>

                    <div class="flex justify-end gap-2 pt-3 border-t">
                        <button v-if="!isNewProduct" @click="deleteProduct(editingProduct)" class="text-red-500 px-4 py-2 hover:bg-red-50 rounded"><i class="fa-solid fa-trash"></i></button>
                        <button @click="editingProduct = null" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded">Annulla</button>
                        <button @click="saveProductEdit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Salva</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentSection === 'Magazzino'">
            <button @click="showAddModal = true" class="w-full bg-blue-600 text-white py-3 rounded-xl shadow-lg mb-6 font-bold flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> Aggiungi al Magazzino
            </button>

            <div v-if="Object.keys(groupedInventory).length === 0" class="text-center text-gray-400 mt-10">
                <i class="fa-solid fa-warehouse text-4xl mb-2"></i>
                <p>Magazzino vuoto</p>
            </div>

            <div v-for="(items, category) in groupedInventory" :key="category" class="mb-6">
                <h2 class="text-blue-600 font-bold mb-2 uppercase text-xs tracking-wider border-b pb-1">{{ category }}</h2>
                <div v-for="item in items" :key="item.id" class="bg-white rounded-lg shadow-sm mb-2 overflow-hidden">
                    <div @click="toggleExpand(item.id)" class="p-3 flex items-center justify-between cursor-pointer active:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 text-blue-800 font-bold w-8 h-8 flex items-center justify-center rounded-full text-sm">
                                {{ getTotalQty(item.id) }}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">{{ item.name }}</h3>
                                <p class="text-xs text-gray-500">{{ item.capacity }} {{ item.unit }}</p>
                            </div>
                        </div>
                        <i :class="expandedItem === item.id ? 'fa-chevron-up' : 'fa-chevron-down'" class="text-gray-400 text-sm transition"></i>
                    </div>
                    <div v-if="expandedItem === item.id" class="bg-gray-50 p-3 border-t text-sm">
                        <div v-for="(batch, index) in item.batches" :key="index" class="flex justify-between items-center mb-2 last:mb-0">
                            <div>
                                <span class="font-bold text-gray-700">{{ batch.qty }} pz</span>
                                <span class="text-gray-500 ml-2">Scad: <span :class="getExpiryColor(batch.expiry)">{{ formatDate(batch.expiry) }}</span></span>
                            </div>
                            <button @click="sellItem(item, index)" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold border border-red-200 hover:bg-red-200">
                                <i class="fa-solid fa-minus"></i> Scarica
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="showAddModal" class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center">
                <div class="bg-white w-full sm:max-w-md p-6 rounded-t-2xl sm:rounded-xl shadow-2xl h-[85vh] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg">Carico Magazzino</h3>
                        <button @click="closeAddModal" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
                    </div>
                    
                    <input v-model="newItemSearch" placeholder="Cerca articolo..." class="w-full p-3 border rounded-lg mb-2 sticky top-0">
                    
                    <div class="flex-1 overflow-y-auto mb-4 border rounded-lg bg-gray-50">
                        <div v-for="prod in filteredAddList" :key="prod.id" @click="selectForAdd(prod)" 
                             :class="selectedProd && selectedProd.id === prod.id ? 'bg-blue-100 border-blue-500' : 'bg-white'"
                             class="p-3 border-b cursor-pointer hover:bg-gray-50 flex justify-between items-center">
                            <span class="font-medium">{{ prod.name }}</span>
                            <span class="text-gray-500 text-xs bg-gray-100 px-2 py-1 rounded-full">{{ prod.cat }}</span>
                        </div>
                        <div v-if="filteredAddList.length === 0 && newItemSearch" class="p-4 text-center text-gray-500">
                            Nessun prodotto trovato.
                        </div>
                    </div>

                    <div v-if="selectedProd" class="bg-blue-50 p-4 rounded-lg mb-4 border border-blue-100 animate-fade-in">
                        <p class="font-bold text-blue-900 mb-3 flex items-center"><i class="fa-solid fa-box mr-2"></i> {{ selectedProd.name }}</p>
                        <div class="flex gap-3 mb-4">
                            <div class="w-1/3">
                                <label class="text-xs text-gray-500 block font-bold mb-1">Quantità</label>
                                <input v-model.number="addQty" type="number" min="1" class="w-full p-2 rounded border font-bold text-center focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="w-2/3">
                                <label class="text-xs text-gray-500 block font-bold mb-1">Scadenza</label>
                                <input v-model="addExpiry" type="date" class="w-full p-2 rounded border focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                        <button @click="confirmAdd" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                            <i class="fa-solid fa-check"></i> Conferma Carico
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentSection === 'Scadenze'">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded shadow-sm flex items-start">
                <div class="flex-shrink-0"><i class="fa-solid fa-triangle-exclamation text-yellow-400"></i></div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 font-medium">Articoli ordinati dalla scadenza più vicina.</p>
                </div>
            </div>
            
            <div v-for="(batch, idx) in allBatchesSorted" :key="idx" class="bg-white p-4 rounded-lg shadow-sm mb-3 flex items-center justify-between border-l-4 transition-all hover:shadow-md" :class="getExpiryBorderColor(batch.expiry)">
                <div>
                    <h3 class="font-bold text-gray-800">{{ batch.name }}</h3>
                    <p class="text-sm text-gray-500">{{ batch.qty }} pezzi disponibili</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-lg" :class="getExpiryColor(batch.expiry)">{{ formatDate(batch.expiry) }}</div>
                    <div class="text-xs font-medium" :class="getExpiryColor(batch.expiry)">{{ getDaysRemaining(batch.expiry) }}</div>
                </div>
            </div>
            <div v-if="allBatchesSorted.length === 0" class="text-center text-gray-400 mt-10">
                <i class="fa-regular fa-calendar-check text-4xl mb-2"></i>
                <p>Nessuna scadenza imminente</p>
            </div>
        </div>

        <div v-if="currentSection === 'Storico'">
            <div v-for="log in historyLogs" :key="log.id" class="bg-white p-4 rounded-lg shadow-sm mb-3 relative border-l-4" :class="log.type === 'OUT' ? 'border-red-400' : 'border-green-400'">
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center gap-2">
                        <span :class="log.type === 'OUT' ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100'" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">
                            <i :class="log.type === 'OUT' ? 'fa-arrow-down' : 'fa-arrow-up'" class="mr-1"></i>{{ log.type === 'OUT' ? 'Vendita' : 'Carico' }}
                        </span>
                        <span class="text-gray-400 text-xs">{{ formatDateTime(log.date) }}</span>
                    </div>
                </div>
                <h3 class="font-bold text-gray-800">{{ log.itemName }} <span class="text-gray-500 font-normal">x {{ log.qty }}</span></h3>
                
                <div class="mt-2 flex items-center bg-gray-50 rounded p-2 border border-dashed border-gray-300 focus-within:border-blue-400 transition-colors">
                    <i class="fa-regular fa-sticky-note text-gray-400 mr-2"></i>
                    <input v-model="log.note" @change="saveHistory" placeholder="Aggiungi una nota..." class="bg-transparent w-full text-sm outline-none text-gray-700 placeholder-gray-400">
                </div>
            </div>
            <div v-if="historyLogs.length === 0" class="text-center text-gray-400 mt-10">
                <i class="fa-solid fa-history text-4xl mb-2"></i>
                <p>Nessun movimento registrato</p>
            </div>
        </div>

        <div v-if="currentSection === 'Opzioni'" class="space-y-4">
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-bold mb-4 border-b pb-2 flex items-center"><i class="fa-solid fa-database mr-2 text-blue-600"></i> Gestione Dati</h3>
                <button @click="exportToExcel" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg mb-3 flex items-center justify-center gap-2 font-bold transition-colors">
                    <i class="fa-solid fa-file-excel"></i> Esporta in Excel
                </button>
                <button @click="backupData" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg mb-3 flex items-center justify-center gap-2 font-bold transition-colors">
                    <i class="fa-solid fa-download"></i> Scarica Backup Dati
                </button>
                <div class="relative group">
                    <input type="file" @change="restoreData" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <button class="w-full bg-blue-500 group-hover:bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 font-bold transition-colors">
                        <i class="fa-solid fa-upload"></i> Ripristina da Backup
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-sm border border-red-100">
                <h3 class="font-bold text-red-600 mb-2 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> Zona Pericolo</h3>
                <p class="text-sm text-gray-500 mb-4">Questa operazione cancellerà permanentemente tutti i dati dell'app.</p>
                <div class="flex gap-2">
                    <input v-model="resetConfirm" placeholder="Scrivi 'CANCELLA' per confermare" class="border p-2 rounded flex-1 text-sm focus:ring-2 focus:ring-red-500 outline-none">
                    <button @click="factoryReset" :disabled="resetConfirm !== 'CANCELLA'" class="bg-red-600 text-white px-4 rounded font-bold disabled:opacity-50 disabled:cursor-not-allowed transition-opacity hover:bg-red-700">Reset Totale</button>
                </div>
            </div>
            <div class="text-center text-xs text-gray-400 mt-8">
                Just Magazzino v1.2
            </div>
        </div>

    </main>

    <nav v-if="currentSection !== 'splash'" class="bg-white border-t flex justify-around items-center pb-safe pt-2 text-xs text-gray-500 fixed bottom-0 w-full z-40 safe-area-bottom shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button @click="currentSection = 'Articoli'" :class="currentSection === 'Articoli' ? 'text-blue-600 font-bold' : 'hover:text-blue-500'" class="flex flex-col items-center p-2 w-1/5 transition-colors">
            <i class="fa-solid fa-list text-xl mb-1"></i> Articoli
        </button>
        <button @click="currentSection = 'Magazzino'" :class="currentSection === 'Magazzino' ? 'text-blue-600 font-bold' : 'hover:text-blue-500'" class="flex flex-col items-center p-2 w-1/5 relative transition-colors">
            <i class="fa-solid fa-boxes-stacked text-xl mb-1"></i> Magazzino
            <span v-if="totalItemsInStock > 0" class="absolute top-1 right-3 min-w-[16px] h-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center px-1 font-bold border-2 border-white">{{ totalItemsInStock }}</span>
        </button>
        <button @click="currentSection = 'Scadenze'" :class="currentSection === 'Scadenze' ? 'text-blue-600 font-bold' : 'hover:text-blue-500'" class="flex flex-col items-center p-2 w-1/5 transition-colors">
            <i class="fa-regular fa-clock text-xl mb-1"></i> Scadenze
        </button>
        <button @click="currentSection = 'Storico'" :class="currentSection === 'Storico' ? 'text-blue-600 font-bold' : 'hover:text-blue-500'" class="flex flex-col items-center p-2 w-1/5 transition-colors">
            <i class="fa-solid fa-history text-xl mb-1"></i> Storico
        </button>
        <button @click="currentSection = 'Opzioni'" :class="currentSection === 'Opzioni' ? 'text-blue-600 font-bold' : 'hover:text-blue-500'" class="flex flex-col items-center p-2 w-1/5 transition-colors">
            <i class="fa-solid fa-cog text-xl mb-1"></i> Opzioni
        </button>
    </nav>

</div>

<script>
    const { createApp } = Vue;

    // PLACEHOLDER PER IMMAGINI MANCANTI
    const PLACEHOLDER_IMG = 'https://via.placeholder.com/150?text=No+Image';

    // DATABASE COMPLETO (Tutti i prodotti della tabella)
    const initialProducts = [
        // BAGNI CALDI ED ESSENZE
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Purificante", capacity: 250, unit: "ml", price: 23.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Tonificante", capacity: 250, unit: "ml", price: 23.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Rilassante", capacity: 250, unit: "ml", price: 23.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Equilibrante", capacity: 250, unit: "ml", price: 23.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Echinacea", capacity: 75, unit: "ml", price: 24.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Timo", capacity: 75, unit: "ml", price: 24.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Ginepro", capacity: 75, unit: "ml", price: 24.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Sandalo", capacity: 75, unit: "ml", price: 24.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Melissa", capacity: 75, unit: "ml", price: 24.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Vivisal", capacity: 500, unit: "gr", price: 30.50, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Scrub Detox Vivisal", capacity: 150, unit: "ml", price: 25.50, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Doccia Schiuma Erbe", capacity: 300, unit: "ml", price: 22.00, img: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Doccia Gel Latte Miele Riso", capacity: 250, unit: "ml", price: 19.00, img: "" },

        // OLI ESSENZIALI
        { cat: "Oli Essenziali", name: "Relax Attivatore", capacity: 10, unit: "ml", price: 19.50, img: "" },
        { cat: "Oli Essenziali", name: "Olio Eucalipto", capacity: 50, unit: "ml", price: 31.50, img: "" },
        { cat: "Oli Essenziali", name: "Olio 31", capacity: 75, unit: "ml", price: 38.00, img: "" },
        { cat: "Oli Essenziali", name: "Olio Limone", capacity: 10, unit: "ml", price: 15.00, img: "" },
        { cat: "Oli Essenziali", name: "Olio Lavanda", capacity: 10, unit: "ml", price: 17.00, img: "" },
        { cat: "Oli Essenziali", name: "Olio Arancio", capacity: 10, unit: "ml", price: 15.00, img: "" },
        { cat: "Oli Essenziali", name: "Olio Menta", capacity: 10, unit: "ml", price: 16.00, img: "" },
        { cat: "Oli Essenziali", name: "Olio Tea Tree", capacity: 10, unit: "ml", price: 19.00, img: "" },
        { cat: "Oli Essenziali", name: "Olio Geranio", capacity: 10, unit: "ml", price: 20.00, img: "" },
        { cat: "Oli Essenziali", name: "Tono e Armonia", capacity: 10, unit: "ml", price: 16.00, img: "" },

        // CREME DERMOATTIVE
        { cat: "Creme Dermoattive", name: "Crema Gel Arnica", capacity: 100, unit: "ml", price: 24.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Tea Tree", capacity: 100, unit: "ml", price: 22.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Attiva", capacity: 100, unit: "ml", price: 22.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Calendula", capacity: 100, unit: "ml", price: 23.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Lavanda", capacity: 100, unit: "ml", price: 23.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Ginepro", capacity: 100, unit: "ml", price: 22.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Timo", capacity: 100, unit: "ml", price: 22.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Gel Consolida", capacity: 100, unit: "ml", price: 23.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Gel Ventonik", capacity: 100, unit: "ml", price: 22.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Mani Camomilla", capacity: 100, unit: "ml", price: 20.00, img: "" },
        { cat: "Creme Dermoattive", name: "Crema Gel Bodyfresh", capacity: 100, unit: "ml", price: 19.00, img: "" },

        // SPECIFICI
        { cat: "Specifici", name: "Eucasol", capacity: 50, unit: "ml", price: 17.00, img: "" },
        { cat: "Specifici", name: "Lozione Anti-Insetti", capacity: 75, unit: "ml", price: 23.00, img: "" },
        { cat: "Specifici", name: "Crema Labbra", capacity: 20, unit: "ml", price: 15.00, img: "" },
        { cat: "Specifici", name: "Gel Lavamani", capacity: 250, unit: "ml", price: 18.00, img: "" },
        { cat: "Specifici", name: "Crema Schiarente", capacity: 100, unit: "ml", price: 26.00, img: "" },
        { cat: "Specifici", name: "Spray Naso Libero", capacity: 100, unit: "ml", price: 24.00, img: "" },
        { cat: "Specifici", name: "Lozione Astringente", capacity: 250, unit: "ml", price: 20.00, img: "" },
        { cat: "Specifici", name: "Olio Riparatore", capacity: 40, unit: "ml", price: 23.00, img: "" },
        { cat: "Specifici", name: "Crema Fango Termale", capacity: 200, unit: "ml", price: 41.00, img: "" },

        // PIEDI E GAMBE
        { cat: "Piedi e Gambe", name: "Sali Piedi Pedisal", capacity: 500, unit: "gr", price: 15.00, img: "" },
        { cat: "Piedi e Gambe", name: "Crema Piedi Pedicream", capacity: 100, unit: "ml", price: 18.00, img: "" },
        { cat: "Piedi e Gambe", name: "Spray Piedi Pedibon", capacity: 75, unit: "ml", price: 18.00, img: "" },

        // MALVA
        { cat: "Malva", name: "Crema Viso Malva", capacity: 50, unit: "ml", price: 32.00, img: "" },
        { cat: "Malva", name: "Latte Malva", capacity: 250, unit: "ml", price: 29.50, img: "" },
        { cat: "Malva", name: "Deo Roll-On Malva", capacity: 50, unit: "ml", price: 17.00, img: "" },

        // IGIENE ORALE
        { cat: "Igiene Orale", name: "Set Igiene Orale Giorno-Notte", capacity: 150, unit: "ml", price: 20.00, img: "" },
        { cat: "Igiene Orale", name: "Collutorio", capacity: 75, unit: "ml", price: 18.00, img: "" },

        // BABY
        { cat: "Baby", name: "Baby Bagno Doccia", capacity: 250, unit: "ml", price: 24.00, img: "" },
        { cat: "Baby", name: "Baby Crema", capacity: 100, unit: "ml", price: 21.00, img: "" },

        // INTIM
        { cat: "Intim", name: "Deo Intim", capacity: 250, unit: "ml", price: 26.00, img: "" },
        { cat: "Intim", name: "Gel Intim", capacity: 30, unit: "ml", price: 14.50, img: "" },

        // LOZIONI CORPO
        { cat: "Lozioni Corpo", name: "Balsamo Corpo", capacity: 250, unit: "ml", price: 22.00, img: "" },
        { cat: "Lozioni Corpo", name: "Olio Riattivante", capacity: 125, unit: "ml", price: 22.00, img: "" },
        { cat: "Lozioni Corpo", name: "Deo Plus", capacity: 75, unit: "ml", price: 17.00, img: "" },
        { cat: "Lozioni Corpo", name: "Latte Mandorle", capacity: 250, unit: "ml", price: 20.00, img: "" },

        // LAMELLODERM
        { cat: "Lamelloderm", name: "Doccia Lamelloderm", capacity: 200, unit: "ml", price: 23.00, img: "" },
        { cat: "Lamelloderm", name: "Crema Lamelloderm Repair", capacity: 100, unit: "ml", price: 33.50, img: "" },

        // BODY REFORM
        { cat: "Body Reform", name: "Fluido Corpo Anticellulite", capacity: 200, unit: "ml", price: 51.00, img: "" },
        { cat: "Body Reform", name: "Fluido Seno Rassodante", capacity: 100, unit: "ml", price: 36.50, img: "" },

        // UOMO
        { cat: "Uomo", name: "Shaving Gel", capacity: 100, unit: "ml", price: 21.00, img: "" },
        { cat: "Uomo", name: "After Shave Gel", capacity: 60, unit: "ml", price: 18.00, img: "" },

        // SOLARI
        { cat: "Solari", name: "Latte Solare 6", capacity: 125, unit: "ml", price: 19.50, img: "" },
        { cat: "Solari", name: "Latte Solare Spray 15", capacity: 200, unit: "ml", price: 31.50, img: "" },
        { cat: "Solari", name: "Latte Solare 30", capacity: 250, unit: "ml", price: 31.50, img: "" },
        { cat: "Solari", name: "Crema Viso Solare 30", capacity: 50, unit: "ml", price: 28.50, img: "" },
        { cat: "Solari", name: "Latte Solare 50", capacity: 125, unit: "ml", price: 29.50, img: "" },
        { cat: "Solari", name: "Gel Doposole", capacity: 250, unit: "ml", price: 31.50, img: "" },

        // INFIORE
        { cat: "Infiore", name: "Crema 24h Rimpolpante", capacity: 50, unit: "ml", price: 59.00, img: "" },
        { cat: "Infiore", name: "Crema Giorno Rigenerante", capacity: 50, unit: "ml", price: 53.00, img: "" },
        { cat: "Infiore", name: "Crema Notte Rigenerante", capacity: 50, unit: "ml", price: 53.00, img: "" },
        { cat: "Infiore", name: "Crema Contorno Occhi", capacity: 30, unit: "ml", price: 50.00, img: "" },
        { cat: "Infiore", name: "Siero Ultra-Rigenerante", capacity: 30, unit: "ml", price: 53.00, img: "" },
        { cat: "Infiore", name: "Crema Detergente", capacity: 125, unit: "ml", price: 30.50, img: "" },
        { cat: "Infiore", name: "Gel Detergente", capacity: 125, unit: "ml", price: 30.50, img: "" },
        { cat: "Infiore", name: "Peeling", capacity: 50, unit: "ml", price: 37.50, img: "" },
        { cat: "Infiore", name: "Maschera Gel Rassodante", capacity: 75, unit: "ml", price: 39.50, img: "" },
        { cat: "Infiore", name: "Idrogel Ultra-Idratante", capacity: 50, unit: "ml", price: 39.50, img: "" },
        { cat: "Infiore", name: "Struccante Micellare", capacity: 150, unit: "ml", price: 24.00, img: "" },
        { cat: "Infiore", name: "Tonico Vitalizzante", capacity: 150, unit: "ml", price: 22.00, img: "" },
        { cat: "Infiore", name: "Latte Corpo Vellutante", capacity: 200, unit: "ml", price: 29.00, img: "" },

        // CAPELLI
        { cat: "Capelli", name: "Shampoo Addolcente", capacity: 250, unit: "ml", price: 23.00, img: "" },
        { cat: "Capelli", name: "Shampoo Rigenerante", capacity: 250, unit: "ml", price: 25.00, img: "" },
        { cat: "Capelli", name: "Shampoo Purificante", capacity: 250, unit: "ml", price: 23.00, img: "" },
        { cat: "Capelli", name: "Shampoo Antiforfora", capacity: 250, unit: "ml", price: 23.00, img: "" },
        { cat: "Capelli", name: "Shampoo Ravvivante", capacity: 250, unit: "ml", price: 24.00, img: "" },
        { cat: "Capelli", name: "Shampoo Tea Tree", capacity: 250, unit: "ml", price: 29.00, img: "" },
        { cat: "Capelli", name: "Shampoo Volumizzante", capacity: 250, unit: "ml", price: 26.00, img: "" },
        { cat: "Capelli", name: "Balsamo Disciplinante", capacity: 150, unit: "ml", price: 22.00, img: "" },
        { cat: "Capelli", name: "Lozione Anticaduta", capacity: 75, unit: "ml", price: 32.50, img: "" },
        { cat: "Capelli", name: "Latte Spray Riparatore", capacity: 120, unit: "ml", price: 26.00, img: "" },

        // INTEGRAZIONE ALIMENTARE
        { cat: "Integrazione Alimentare", name: "+Energy", capacity: 60, unit: "gr", price: 34.50, img: "" },

        // AMICI ANIMALI
        { cat: "Amici Animali", name: "Shampoo Cani e Gatti", capacity: 200, unit: "ml", price: 18.00, img: "" },

        // CASA
        { cat: "Casa", name: "Detergente NR Plus", capacity: 1000, unit: "ml", price: 22.00, img: "" },
        { cat: "Casa", name: "Spray Lavanda", capacity: 115, unit: "ml", price: 31.50, img: "" },
        { cat: "Casa", name: "Spray Ambientale", capacity: 200, unit: "ml", price: 21.00, img: "" },
        { cat: "Casa", name: "Smacchiatore Pretrattante", capacity: 75, unit: "ml", price: 13.00, img: "" },
        { cat: "Casa", name: "Cura Legno", capacity: 200, unit: "ml", price: 22.00, img: "" }
    ].map((p, i) => ({ ...p, id: i + 1 }));

    createApp({
        data() {
            return {
                currentSection: 'splash',
                searchQuery: '',
                newItemSearch: '',
                products: [],
                inventory: [],
                historyLogs: [],
                
                showAddModal: false,
                selectedProd: null,
                addQty: 1,
                addExpiry: '',
                expandedItem: null,
                editingProduct: null,
                isNewProduct: false, // Flag per sapere se sto aggiungendo o modificando
                resetConfirm: ''
            }
        },
        mounted() {
            // Caricamento dati dal localStorage
            const savedProducts = localStorage.getItem('just_products');
            const savedInventory = localStorage.getItem('just_inventory');
            const savedHistory = localStorage.getItem('just_history');

            // Se ci sono prodotti salvati, li carico. Altrimenti uso quelli iniziali.
            if (savedProducts) {
                this.products = JSON.parse(savedProducts);
                // Migrazione dati per compatibilità (se necessario)
                this.products.forEach(p => {
                    if (p.ml && !p.capacity) { // Vecchio formato
                        const parts = p.ml.split(' ');
                        p.capacity = parseFloat(parts[0]);
                        p.unit = parts[1] || 'ml';
                        delete p.ml;
                    }
                    if (!p.img) p.img = ""; // Assicuro che il campo img esista
                });
            } else {
                this.products = initialProducts;
                this.saveData();
            }

            if (savedInventory) this.inventory = JSON.parse(savedInventory);
            if (savedHistory) this.historyLogs = JSON.parse(savedHistory);
        },
        computed: {
            filteredProducts() {
                const q = this.searchQuery.toLowerCase();
                const filtered = this.products.filter(p => p.name.toLowerCase().includes(q));
                return filtered.reduce((groups, item) => {
                    const group = (groups[item.cat] || []);
                    group.push(item);
                    groups[item.cat] = group;
                    return groups;
                }, {});
            },
            // Calcola la lista delle categorie uniche per il datalist
            uniqueCategories() {
                return [...new Set(this.products.map(p => p.cat))].sort();
            },
            filteredAddList() {
                if(!this.newItemSearch) return [];
                const q = this.newItemSearch.toLowerCase();
                return this.products.filter(p => p.name.toLowerCase().includes(q));
            },
            groupedInventory() {
                const grouped = {};
                this.inventory.forEach(batch => {
                    const prod = this.products.find(p => p.id === batch.prodId);
                    if (!prod) return;
                    
                    if (!grouped[prod.cat]) grouped[prod.cat] = [];
                    
                    let itemEntry = grouped[prod.cat].find(i => i.id === prod.id);
                    if (!itemEntry) {
                        itemEntry = { ...prod, batches: [] };
                        grouped[prod.cat].push(itemEntry);
                    }
                    
                    itemEntry.batches.push(batch);
                });
                return grouped;
            },
            totalItemsInStock() {
                return this.inventory.reduce((sum, batch) => sum + batch.qty, 0);
            },
            allBatchesSorted() {
                const list = this.inventory.map(batch => {
                    const prod = this.products.find(p => p.id === batch.prodId);
                    return {
                        ...batch,
                        name: prod ? prod.name : 'Prodotto eliminato',
                        capacity: prod ? prod.capacity : '',
                        unit: prod ? prod.unit : ''
                    };
                }).filter(b => b.name !== 'Prodotto eliminato');
                return list.sort((a, b) => new Date(a.expiry) - new Date(b.expiry));
            }
        },
        methods: {
            // Navigazione
            enterApp() {
                this.currentSection = 'Magazzino';
            },
            // Gestione Dati
            saveData() {
                localStorage.setItem('just_products', JSON.stringify(this.products));
                localStorage.setItem('just_inventory', JSON.stringify(this.inventory));
                localStorage.setItem('just_history', JSON.stringify(this.historyLogs));
            },
            // GESTIONE PRODOTTI (Modifica e Aggiunta)
            editProduct(prod) {
                this.isNewProduct = false;
                this.editingProduct = { ...prod }; // Crea una copia per la modifica
            },
            openNewProductModal() {
                this.isNewProduct = true;
                // Oggetto prodotto vuoto per l'inserimento
                this.editingProduct = { 
                    id: Date.now(), // ID temporaneo univoco
                    name: '', 
                    cat: '', 
                    capacity: null, 
                    unit: 'ml', // Default
                    price: null, 
                    img: '' 
                };
            },
            saveProductEdit() {
                // Validazione basilare
                if (!this.editingProduct.name || !this.editingProduct.cat) {
                    alert("Nome e Categoria sono obbligatori.");
                    return;
                }

                if (this.isNewProduct) {
                    // Aggiungi nuovo prodotto alla lista
                    this.products.push(this.editingProduct);
                    alert("Prodotto aggiunto con successo!");
                } else {
                    // Trova e aggiorna il prodotto esistente
                    const idx = this.products.findIndex(p => p.id === this.editingProduct.id);
                    if (idx !== -1) {
                        this.products[idx] = this.editingProduct;
                    }
                }
                this.saveData();
                this.editingProduct = null; // Chiudi la modale
            },
            deleteProduct(prod) {
                if(confirm(`Sei sicuro di voler eliminare "${prod.name}"?`)) {
                    this.products = this.products.filter(p => p.id !== prod.id);
                    this.saveData();
                    this.editingProduct = null;
                }
            },
            // Gestione Errore Immagine: Imposta il placeholder
            imageError(e) {
                e.target.src = PLACEHOLDER_IMG;
            },
            
            // MAGAZZINO
            selectForAdd(prod) {
                this.selectedProd = prod;
            },
            closeAddModal() {
                this.showAddModal = false;
                this.selectedProd = null;
                this.addQty = 1;
                this.newItemSearch = '';
                this.addExpiry = '';
            },
            confirmAdd() {
                if (!this.selectedProd) { alert('Seleziona un prodotto'); return; }
                if (!this.addExpiry) { alert('Inserisci la data di scadenza'); return; }
                if (this.addQty <= 0) { alert('La quantità deve essere maggiore di zero'); return; }
                
                this.inventory.push({
                    prodId: this.selectedProd.id,
                    qty: this.addQty,
                    expiry: this.addExpiry,
                    dateAdded: new Date().toISOString()
                });

                this.logHistory(this.selectedProd.name, this.addQty, 'IN');
                this.saveData();
                this.closeAddModal();
            },
            toggleExpand(id) {
                this.expandedItem = this.expandedItem === id ? null : id;
            },
            getTotalQty(prodId) {
                return this.inventory
                    .filter(b => b.prodId === prodId)
                    .reduce((sum, b) => sum + b.qty, 0);
            },
            sellItem(item, batchIndex) {
                const batch = item.batches[batchIndex];
                let qtyToSell = 1;

                if (batch.qty > 1) {
                    const input = prompt(`Quanti pezzi di "${item.name}" vuoi scaricare? (Disponibili: ${batch.qty})`, "1");
                    if (input === null) return;
                    qtyToSell = parseInt(input);
                    if (isNaN(qtyToSell) || qtyToSell > batch.qty || qtyToSell <= 0) {
                        alert("Quantità non valida");
                        return;
                    }
                }

                batch.qty -= qtyToSell;
                if (batch.qty === 0) {
                    const realIndex = this.inventory.findIndex(b => b === batch);
                    if (realIndex > -1) this.inventory.splice(realIndex, 1);
                }

                this.logHistory(item.name, qtyToSell, 'OUT');
                this.saveData();
            },

            // STORICO & UTILS
            logHistory(name, qty, type) {
                this.historyLogs.unshift({
                    id: Date.now(),
                    itemName: name,
                    qty: qty,
                    type: type,
                    date: new Date().toISOString(),
                    note: ''
                });
            },
            saveHistory() {
                localStorage.setItem('just_history', JSON.stringify(this.historyLogs));
            },
            formatDate(dateStr) {
                if(!dateStr) return 'N/A';
                const d = new Date(dateStr);
                return d.toLocaleDateString('it-IT', { year: '2-digit', month: '2-digit', day: '2-digit' });
            },
            formatDateTime(isoStr) {
                const d = new Date(isoStr);
                return d.toLocaleString('it-IT', { dateStyle: 'short', timeStyle: 'short' });
            },
            getDaysRemaining(expiry) {
                if(!expiry) return '';
                const today = new Date();
                today.setHours(0,0,0,0);
                const expDate = new Date(expiry);
                expDate.setHours(0,0,0,0);
                
                const diffTime = expDate - today;
                const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (days < 0) return "SCADUTO";
                if (days === 0) return "Scade oggi";
                if (days === 1) return "Scade domani";
                return `${days} giorni`;
            },
            getExpiryColor(expiry) {
                const days = this.getDaysDiff(expiry);
                if (days < 0) return 'text-red-700 font-bold';
                if (days < 30) return 'text-orange-500 font-bold';
                return 'text-green-600';
            },
            getExpiryBorderColor(expiry) {
                const days = this.getDaysDiff(expiry);
                if (days < 0) return 'border-red-500 bg-red-50';
                if (days < 60) return 'border-yellow-400 bg-yellow-50';
                return 'border-green-500 border-l-[6px]';
            },
            getDaysDiff(expiry) {
                const today = new Date();
                today.setHours(0,0,0,0);
                const expDate = new Date(expiry);
                expDate.setHours(0,0,0,0);
                return Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
            },

            // EXPORT & OPZIONI
            exportToExcel() {
                const wb = XLSX.utils.book_new();
                
                // Foglio 1: Articoli (Formattato)
                const articoliData = this.products.map(p => ({
                    Categoria: p.cat,
                    Nome: p.name,
                    'Capacità': p.capacity,
                    'Unità': p.unit,
                    'Prezzo (€)': p.price
                }));
                const wsArticoli = XLSX.utils.json_to_sheet(articoliData);
                XLSX.utils.book_append_sheet(wb, wsArticoli, "Articoli");

                // Foglio 2: Magazzino
                const magazzinoData = this.inventory.map(i => {
                    const p = this.products.find(x => x.id === i.prodId);
                    return {
                        Categoria: p?.cat || 'N/A',
                        Prodotto: p?.name || 'N/A',
                        'Qta': i.qty,
                        'Scadenza': this.formatDate(i.expiry)
                    };
                });
                const wsMagazzino = XLSX.utils.json_to_sheet(magazzinoData);
                XLSX.utils.book_append_sheet(wb, wsMagazzino, "Magazzino");

                // Altri fogli...
                const wsScadenze = XLSX.utils.json_to_sheet(this.allBatchesSorted.map(i => ({ Prodotto: i.name, Qta: i.qty, Scadenza: this.formatDate(i.expiry) })));
                XLSX.utils.book_append_sheet(wb, wsScadenze, "Scadenze");

                const wsStorico = XLSX.utils.json_to_sheet(this.historyLogs.map(l => ({ Data: this.formatDateTime(l.date), Tipo: l.type === 'IN' ? 'Carico' : 'Vendita', Prodotto: l.itemName, Qta: l.qty, Note: l.note })));
                XLSX.utils.book_append_sheet(wb, wsStorico, "Storico");

                XLSX.writeFile(wb, "Just_Magazzino_Export.xlsx");
            },
            backupData() {
                const data = { products: this.products, inventory: this.inventory, history: this.historyLogs };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `just_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            restoreData(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.products && data.inventory && data.history) {
                            this.products = data.products;
                            this.inventory = data.inventory;
                            this.historyLogs = data.history;
                            this.saveData();
                            alert("Backup ripristinato con successo! L'app verrà ricaricata.");
                            location.reload();
                        } else { throw new Error('Formato non valido'); }
                    } catch(err) { alert("Errore: Il file di backup non è valido."); }
                };
                reader.readAsText(file);
                e.target.value = ''; // Reset input file
            },
            factoryReset() {
                if(confirm("ATTENZIONE: Stai per cancellare TUTTI i dati. Sei sicuro?")) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }
    }).mount('#app');
</script>
</body>
</html>