<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Just Magazzino</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Stili personalizzati */
        body { -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .splash-screen { background: url('background.png') no-repeat center center; background-size: cover; cursor: pointer; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Stile Select (Menu a tendina) più pulito */
        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1em; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen overflow-hidden">

<div id="app" class="h-full flex flex-col">

    <div v-if="currentSection === 'splash'" @click="enterApp" class="splash-screen absolute inset-0 z-50"></div>

    <header v-else class="bg-white shadow-sm pt-12 pb-4 px-4 flex justify-between items-center z-10">
        <h1 class="text-xl font-bold text-blue-800 capitalize">{{ currentSection }}</h1>
        <div class="text-sm text-gray-500">{{ totalItemsInStock }} Pz Totali</div>
    </header>

    <main v-if="currentSection !== 'splash'" class="flex-1 overflow-y-auto p-4 safe-area-bottom pb-24">
        
        <div v-if="currentSection === 'Articoli'">
            <button @click="openNewProductModal" class="w-full bg-blue-600 text-white py-3 rounded-xl shadow-lg mb-4 font-bold flex items-center justify-center gap-2 active:bg-blue-700">
                <i class="fa-solid fa-plus"></i> Aggiungi Nuovo Prodotto
            </button>

            <div class="mb-4 sticky top-0 bg-gray-50 pt-2 pb-2 z-10">
                <input v-model="searchQuery" placeholder="Cerca prodotto..." class="w-full p-3 rounded-xl border border-gray-300 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div v-for="(products, category) in filteredProducts" :key="category" class="mb-6">
                <h2 class="text-blue-600 font-bold mb-2 uppercase text-xs tracking-wider border-b pb-1">{{ category }}</h2>
                <div v-for="prod in products" :key="prod.id" class="bg-white p-3 rounded-lg shadow-sm mb-2 flex items-center gap-3">
                    
                    <a :href="prod.link || '#'" target="_blank" class="block shrink-0 relative group">
                        <img :src="prod.img" class="w-12 h-12 object-cover rounded-md bg-gray-100 border" @error="imageError">
                        <div v-if="prod.link" class="absolute bottom-0 right-0 bg-blue-600 text-white rounded-tl-md text-[8px] p-1">
                            <i class="fa-solid fa-external-link-alt"></i>
                        </div>
                    </a>

                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800 leading-tight">{{ prod.name }}</h3>
                        <p class="text-xs text-gray-500">{{ prod.capacity }} {{ prod.unit }} - {{ prod.price.toFixed(2) }} €</p>
                    </div>
                    <button @click="editProduct(prod)" class="text-gray-400 hover:text-blue-500 p-3"><i class="fa-solid fa-pencil"></i></button>
                </div>
            </div>
        </div>

        <div v-if="currentSection === 'Magazzino'">
            <button @click="showAddModal = true" class="w-full bg-blue-600 text-white py-3 rounded-xl shadow-lg mb-6 font-bold flex items-center justify-center gap-2 active:bg-blue-700">
                <i class="fa-solid fa-plus-circle"></i> Aggiungi al Magazzino
            </button>

            <div v-if="Object.keys(groupedInventory).length === 0" class="text-center text-gray-400 mt-10">
                <i class="fa-solid fa-warehouse text-4xl mb-2"></i>
                <p>Magazzino vuoto</p>
            </div>

            <div v-for="(items, category) in groupedInventory" :key="category" class="mb-6">
                <h2 class="text-blue-600 font-bold mb-2 uppercase text-xs tracking-wider border-b pb-1">{{ category }}</h2>
                <div v-for="item in items" :key="item.id" class="bg-white rounded-lg shadow-sm mb-2 overflow-hidden">
                    <div @click="toggleExpand(item.id)" class="p-3 flex items-center justify-between cursor-pointer active:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="bg-blue-100 text-blue-800 font-bold w-8 h-8 flex items-center justify-center rounded-full text-sm">
                                {{ getTotalQty(item.id) }}
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">{{ item.name }}</h3>
                                <p class="text-xs text-gray-500">{{ item.capacity }} {{ item.unit }}</p>
                            </div>
                        </div>
                        <i :class="expandedItem === item.id ? 'fa-chevron-up' : 'fa-chevron-down'" class="text-gray-400 text-sm transition"></i>
                    </div>
                    <div v-if="expandedItem === item.id" class="bg-gray-50 p-3 border-t text-sm">
                        <div v-for="(batch, index) in item.batches" :key="index" class="flex justify-between items-center mb-3 last:mb-0 border-b last:border-0 pb-2 last:pb-0 border-gray-200">
                            <div class="flex-1">
                                <span class="font-bold text-gray-700 text-lg">{{ batch.qty }} pz</span>
                                <div class="text-gray-500 text-xs">Scad: <span :class="getExpiryColor(batch.expiry)">{{ formatDate(batch.expiry) }}</span></div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="openEditBatchModal(item, index)" class="bg-yellow-100 text-yellow-600 w-8 h-8 rounded-full flex items-center justify-center shadow-sm active:scale-95">
                                    <i class="fa-solid fa-pencil text-xs"></i>
                                </button>
                                <button @click="openSellModal(item, index)" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold border border-red-200 active:bg-red-200 shadow-sm">
                                    <i class="fa-solid fa-minus"></i> Scarica
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentSection === 'Scadenze'">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4 rounded shadow-sm flex items-start">
                <div class="flex-shrink-0"><i class="fa-solid fa-triangle-exclamation text-yellow-400"></i></div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 font-medium">Articoli ordinati dalla scadenza più vicina.</p>
                </div>
            </div>
            
            <div v-for="(batch, idx) in allBatchesSorted" :key="idx" class="bg-white p-4 rounded-lg shadow-sm mb-3 flex items-center justify-between border-l-4" :class="getExpiryBorderColor(batch.expiry)">
                <div>
                    <h3 class="font-bold text-gray-800">{{ batch.name }}</h3>
                    <p class="text-sm text-gray-500">{{ batch.qty }} pezzi disponibili</p>
                </div>
                <div class="text-right">
                    <div class="font-bold text-lg" :class="getExpiryColor(batch.expiry)">{{ formatDate(batch.expiry) }}</div>
                    <div class="text-xs font-medium" :class="getExpiryColor(batch.expiry)">{{ getDaysRemaining(batch.expiry) }}</div>
                </div>
            </div>
        </div>

        <div v-if="currentSection === 'Storico'">
            <div v-for="log in historyLogs" :key="log.id" class="bg-white p-4 rounded-lg shadow-sm mb-3 relative border-l-4" :class="log.type === 'OUT' ? 'border-red-400' : 'border-green-400'">
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center gap-2">
                        <span :class="log.type === 'OUT' ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100'" class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">
                            <i :class="log.type === 'OUT' ? 'fa-arrow-down' : 'fa-arrow-up'" class="mr-1"></i>{{ log.type === 'OUT' ? 'Vendita' : 'Carico' }}
                        </span>
                        <span class="text-gray-400 text-xs">{{ formatDateTime(log.date) }}</span>
                    </div>
                </div>
                <h3 class="font-bold text-gray-800">{{ log.itemName }} <span class="text-gray-500 font-normal">x {{ log.qty }}</span></h3>
                <div class="mt-2 flex items-center bg-gray-50 rounded p-2 border border-dashed border-gray-300">
                    <i class="fa-regular fa-sticky-note text-gray-400 mr-2"></i>
                    <input v-model="log.note" @change="saveHistory" placeholder="Aggiungi una nota..." class="bg-transparent w-full text-sm outline-none text-gray-700">
                </div>
            </div>
        </div>

        <div v-if="currentSection === 'Opzioni'" class="space-y-4">
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-bold mb-4 border-b pb-2 flex items-center"><i class="fa-solid fa-database mr-2 text-blue-600"></i> Gestione Dati</h3>
                <button @click="exportToExcel" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg mb-3 flex items-center justify-center gap-2 font-bold shadow">
                    <i class="fa-solid fa-file-excel"></i> Esporta in Excel
                </button>
                <button @click="backupData" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg mb-3 flex items-center justify-center gap-2 font-bold shadow">
                    <i class="fa-solid fa-download"></i> Scarica Backup Dati
                </button>
                <div class="relative group">
                    <input type="file" @change="restoreData" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                    <button class="w-full bg-blue-500 group-hover:bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 font-bold shadow">
                        <i class="fa-solid fa-upload"></i> Ripristina da Backup
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg shadow-sm border border-red-100">
                <h3 class="font-bold text-red-600 mb-2 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> Zona Pericolo</h3>
                <div class="flex gap-2">
                    <input v-model="resetConfirm" placeholder="Scrivi 'CANCELLA'" class="border p-2 rounded flex-1 text-sm focus:ring-2 focus:ring-red-500 outline-none">
                    <button @click="factoryReset" :disabled="resetConfirm !== 'CANCELLA'" class="bg-red-600 text-white px-4 rounded font-bold disabled:opacity-50 transition-opacity">Reset</button>
                </div>
            </div>
        </div>
    </main>

    <nav v-if="currentSection !== 'splash'" class="bg-white border-t flex justify-around items-center pb-safe pt-2 text-xs text-gray-500 fixed bottom-0 w-full z-40 safe-area-bottom shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button @click="currentSection = 'Articoli'" :class="currentSection === 'Articoli' ? 'text-blue-600 font-bold' : ''" class="flex flex-col items-center p-2 w-1/5">
            <i class="fa-solid fa-list text-xl mb-1"></i> Articoli
        </button>
        <button @click="currentSection = 'Magazzino'" :class="currentSection === 'Magazzino' ? 'text-blue-600 font-bold' : ''" class="flex flex-col items-center p-2 w-1/5 relative">
            <i class="fa-solid fa-boxes-stacked text-xl mb-1"></i> Magazzino
            <span v-if="totalItemsInStock > 0" class="absolute top-1 right-3 min-w-[16px] h-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center px-1 font-bold border-2 border-white">{{ totalItemsInStock }}</span>
        </button>
        <button @click="currentSection = 'Scadenze'" :class="currentSection === 'Scadenze' ? 'text-blue-600 font-bold' : ''" class="flex flex-col items-center p-2 w-1/5">
            <i class="fa-regular fa-clock text-xl mb-1"></i> Scadenze
        </button>
        <button @click="currentSection = 'Storico'" :class="currentSection === 'Storico' ? 'text-blue-600 font-bold' : ''" class="flex flex-col items-center p-2 w-1/5">
            <i class="fa-solid fa-history text-xl mb-1"></i> Storico
        </button>
        <button @click="currentSection = 'Opzioni'" :class="currentSection === 'Opzioni' ? 'text-blue-600 font-bold' : ''" class="flex flex-col items-center p-2 w-1/5">
            <i class="fa-solid fa-cog text-xl mb-1"></i> Opzioni
        </button>
    </nav>

    <div v-if="showAddModal" class="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center animate-fade-in">
        <div class="bg-white w-full sm:max-w-md p-6 rounded-t-2xl sm:rounded-xl shadow-2xl h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-lg">Nuovo Carico</h3>
                <button @click="closeAddModal" class="text-gray-400 p-2"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <input v-if="!selectedProd" v-model="newItemSearch" placeholder="Cerca articolo da caricare..." class="w-full p-3 border rounded-lg mb-2 bg-gray-50 focus:bg-white transition-colors">
            
            <div v-if="!selectedProd" class="flex-1 overflow-y-auto mb-4 border rounded-lg bg-white">
                <div v-for="prod in filteredAddList" :key="prod.id" @click="startAddProcess(prod)" 
                     class="p-3 border-b cursor-pointer hover:bg-blue-50 flex justify-between items-center active:bg-blue-100">
                    <span class="font-medium">{{ prod.name }}</span>
                    <span class="text-gray-500 text-xs bg-gray-100 px-2 py-1 rounded-full">{{ prod.cat }}</span>
                </div>
            </div>

            <div v-else class="flex-1 flex flex-col overflow-hidden">
                <div class="bg-blue-50 p-3 rounded-lg mb-4 border border-blue-100 flex justify-between items-center">
                    <p class="font-bold text-blue-900"><i class="fa-solid fa-box mr-2"></i> {{ selectedProd.name }}</p>
                    <button @click="selectedProd = null" class="text-xs text-blue-600 underline">Cambia</button>
                </div>

                <div class="flex-1 overflow-y-auto pr-1">
                    <div v-for="(batch, idx) in addBatches" :key="idx" class="flex gap-2 items-end mb-4 bg-gray-50 p-2 rounded border">
                        <div class="w-1/3">
                            <label class="text-[10px] text-gray-500 block font-bold mb-1 uppercase">Quantità</label>
                            <select v-model.number="batch.qty" class="w-full p-2 rounded border bg-white font-bold text-center">
                                <option v-for="n in 50" :key="n" :value="n">{{ n }}</option>
                            </select>
                        </div>
                        <div class="w-2/3">
                            <label class="text-[10px] text-gray-500 block font-bold mb-1 uppercase">Scadenza</label>
                            <input v-model="batch.expiry" type="date" class="w-full p-2 rounded border bg-white h-[42px]">
                        </div>
                        <button v-if="addBatches.length > 1" @click="removeBatchRow(idx)" class="text-red-500 p-2 mb-1">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    <button @click="addBatchRow" class="w-full border-2 border-dashed border-green-500 text-green-600 py-2 rounded-lg font-bold mb-4 hover:bg-green-50 active:bg-green-100">
                        <i class="fa-solid fa-plus"></i> Aggiungi altra scadenza
                    </button>
                </div>

                <button @click="confirmAdd" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-transform mt-2">
                    <i class="fa-solid fa-check"></i> CONFERMA CARICO
                </button>
            </div>
        </div>
    </div>

    <div v-if="showSellModal" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl text-center">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Scarico Magazzino</h3>
            <p class="text-gray-500 text-sm mb-4">{{ sellData.itemName }} (Scad: {{ formatDate(sellData.expiry) }})</p>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">Quantità da scaricare</label>
                <select v-model.number="sellData.selectedQty" class="w-full p-3 text-xl font-bold text-center border-2 border-blue-500 rounded-xl bg-white text-blue-600">
                    <option v-for="n in sellData.maxQty" :key="n" :value="n">{{ n }}</option>
                </select>
            </div>

            <div class="flex gap-3">
                <button @click="showSellModal = false" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl active:bg-gray-200">Annulla</button>
                <button @click="confirmSell" class="flex-1 py-3 text-white font-bold bg-red-500 rounded-xl shadow-lg active:scale-95 transition-transform">Conferma</button>
            </div>
        </div>
    </div>

    <div v-if="editBatchData" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Modifica Lotto</h3>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Quantità</label>
                <select v-model.number="editBatchData.qty" class="w-full p-2 border rounded-lg bg-white font-bold">
                    <option v-for="n in 100" :key="n" :value="n">{{ n }}</option>
                </select>
            </div>
            <div class="mb-6">
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Scadenza</label>
                <input v-model="editBatchData.expiry" type="date" class="w-full p-2 border rounded-lg bg-white">
            </div>
            <div class="flex gap-3">
                <button @click="editBatchData = null" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl">Annulla</button>
                <button @click="saveBatchEdit" class="flex-1 py-3 text-white font-bold bg-blue-600 rounded-xl shadow active:bg-blue-700">Salva Modifiche</button>
            </div>
        </div>
    </div>

    <div v-if="editingProduct" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm overflow-y-auto max-h-[90vh]">
            <h3 class="font-bold mb-4 text-lg">{{ isNewProduct ? 'Nuovo Prodotto' : 'Modifica Prodotto' }}</h3>
            <div class="mb-3">
                <label class="block text-xs text-gray-500 mb-1 font-bold">Nome</label>
                <input v-model="editingProduct.name" class="w-full border p-2 rounded">
            </div>
            <div class="mb-3">
                <label class="block text-xs text-gray-500 mb-1 font-bold">Categoria</label>
                <input v-model="editingProduct.cat" class="w-full border p-2 rounded" list="category-list">
                <datalist id="category-list"><option v-for="cat in uniqueCategories" :value="cat"></option></datalist>
            </div>
            <div class="flex gap-3 mb-3">
                <div class="w-2/3">
                    <label class="block text-xs text-gray-500 mb-1 font-bold">Capacità</label>
                    <input v-model.number="editingProduct.capacity" type="number" class="w-full border p-2 rounded">
                </div>
                <div class="w-1/3">
                    <label class="block text-xs text-gray-500 mb-1 font-bold">Unità</label>
                    <select v-model="editingProduct.unit" class="w-full border p-2 rounded bg-white">
                        <option value="ml">ml</option><option value="gr">gr</option><option value="pz">pz</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label class="block text-xs text-gray-500 mb-1 font-bold">Prezzo (€)</label>
                <input v-model.number="editingProduct.price" type="number" step="0.01" class="w-full border p-2 rounded">
            </div>
            <div class="mb-3">
                <label class="block text-xs text-gray-500 mb-1 font-bold">URL Immagine</label>
                <input v-model="editingProduct.img" class="w-full border p-2 rounded text-xs" placeholder="Incolla link foto qui">
            </div>
            <div class="mb-4">
                <label class="block text-xs text-gray-500 mb-1 font-bold text-blue-600">Link Pagina Prodotto</label>
                <input v-model="editingProduct.link" class="w-full border-blue-200 border p-2 rounded text-xs" placeholder="Incolla link pagina Just qui">
            </div>

            <div class="flex justify-end gap-2 pt-3 border-t">
                <button v-if="!isNewProduct" @click="deleteProduct(editingProduct)" class="text-red-500 px-4 py-2"><i class="fa-solid fa-trash"></i></button>
                <button @click="editingProduct = null" class="text-gray-500 px-4 py-2">Annulla</button>
                <button @click="saveProductEdit" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Salva</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp } = Vue;
    const PLACEHOLDER_IMG = 'https://via.placeholder.com/150?text=No+Image';

    // DATABASE COMPLETO
    const initialProducts = [
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Purificante", capacity: 250, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Tonificante", capacity: 250, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Rilassante", capacity: 250, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Equilibrante", capacity: 250, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Echinacea", capacity: 75, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Timo", capacity: 75, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Ginepro", capacity: 75, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Sandalo", capacity: 75, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Essenza Melissa", capacity: 75, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Bagno Vivisal", capacity: 500, unit: "gr", price: 30.50, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Scrub Detox Vivisal", capacity: 150, unit: "ml", price: 25.50, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Doccia Schiuma Erbe", capacity: 300, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Bagni Caldi ed Essenze", name: "Doccia Gel Latte Miele Riso", capacity: 250, unit: "ml", price: 19.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Relax Attivatore", capacity: 10, unit: "ml", price: 19.50, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio Eucalipto", capacity: 50, unit: "ml", price: 31.50, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio 31", capacity: 75, unit: "ml", price: 38.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio Limone", capacity: 10, unit: "ml", price: 15.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio Lavanda", capacity: 10, unit: "ml", price: 17.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio Arancio", capacity: 10, unit: "ml", price: 15.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio Menta", capacity: 10, unit: "ml", price: 16.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio Tea Tree", capacity: 10, unit: "ml", price: 19.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Olio Geranio", capacity: 10, unit: "ml", price: 20.00, img: "", link: "" },
        { cat: "Oli Essenziali", name: "Tono e Armonia", capacity: 10, unit: "ml", price: 16.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Gel Arnica", capacity: 100, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Tea Tree", capacity: 100, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Attiva", capacity: 100, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Calendula", capacity: 100, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Lavanda", capacity: 100, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Ginepro", capacity: 100, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Timo", capacity: 100, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Gel Consolida", capacity: 100, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Gel Ventonik", capacity: 100, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Mani Camomilla", capacity: 100, unit: "ml", price: 20.00, img: "", link: "" },
        { cat: "Creme Dermoattive", name: "Crema Gel Bodyfresh", capacity: 100, unit: "ml", price: 19.00, img: "", link: "" },
        { cat: "Specifici", name: "Eucasol", capacity: 50, unit: "ml", price: 17.00, img: "", link: "" },
        { cat: "Specifici", name: "Lozione Anti-Insetti", capacity: 75, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Specifici", name: "Crema Labbra", capacity: 20, unit: "ml", price: 15.00, img: "", link: "" },
        { cat: "Specifici", name: "Gel Lavamani", capacity: 250, unit: "ml", price: 18.00, img: "", link: "" },
        { cat: "Specifici", name: "Crema Schiarente", capacity: 100, unit: "ml", price: 26.00, img: "", link: "" },
        { cat: "Specifici", name: "Spray Naso Libero", capacity: 100, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Specifici", name: "Lozione Astringente", capacity: 250, unit: "ml", price: 20.00, img: "", link: "" },
        { cat: "Specifici", name: "Olio Riparatore", capacity: 40, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Specifici", name: "Crema Fango Termale", capacity: 200, unit: "ml", price: 41.00, img: "", link: "" },
        { cat: "Piedi e Gambe", name: "Sali Piedi Pedisal", capacity: 500, unit: "gr", price: 15.00, img: "", link: "" },
        { cat: "Piedi e Gambe", name: "Crema Piedi Pedicream", capacity: 100, unit: "ml", price: 18.00, img: "", link: "" },
        { cat: "Piedi e Gambe", name: "Spray Piedi Pedibon", capacity: 75, unit: "ml", price: 18.00, img: "", link: "" },
        { cat: "Malva", name: "Crema Viso Malva", capacity: 50, unit: "ml", price: 32.00, img: "", link: "" },
        { cat: "Malva", name: "Latte Malva", capacity: 250, unit: "ml", price: 29.50, img: "", link: "" },
        { cat: "Malva", name: "Deo Roll-On Malva", capacity: 50, unit: "ml", price: 17.00, img: "", link: "" },
        { cat: "Igiene Orale", name: "Set Igiene Orale Giorno-Notte", capacity: 150, unit: "ml", price: 20.00, img: "", link: "" },
        { cat: "Igiene Orale", name: "Collutorio", capacity: 75, unit: "ml", price: 18.00, img: "", link: "" },
        { cat: "Baby", name: "Baby Bagno Doccia", capacity: 250, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Baby", name: "Baby Crema", capacity: 100, unit: "ml", price: 21.00, img: "", link: "" },
        { cat: "Intim", name: "Deo Intim", capacity: 250, unit: "ml", price: 26.00, img: "", link: "" },
        { cat: "Intim", name: "Gel Intim", capacity: 30, unit: "ml", price: 14.50, img: "", link: "" },
        { cat: "Lozioni Corpo", name: "Balsamo Corpo", capacity: 250, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Lozioni Corpo", name: "Olio Riattivante", capacity: 125, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Lozioni Corpo", name: "Deo Plus", capacity: 75, unit: "ml", price: 17.00, img: "", link: "" },
        { cat: "Lozioni Corpo", name: "Latte Mandorle", capacity: 250, unit: "ml", price: 20.00, img: "", link: "" },
        { cat: "Lamelloderm", name: "Doccia Lamelloderm", capacity: 200, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Lamelloderm", name: "Crema Lamelloderm Repair", capacity: 100, unit: "ml", price: 33.50, img: "", link: "" },
        { cat: "Body Reform", name: "Fluido Corpo Anticellulite", capacity: 200, unit: "ml", price: 51.00, img: "", link: "" },
        { cat: "Body Reform", name: "Fluido Seno Rassodante", capacity: 100, unit: "ml", price: 36.50, img: "", link: "" },
        { cat: "Uomo", name: "Shaving Gel", capacity: 100, unit: "ml", price: 21.00, img: "", link: "" },
        { cat: "Uomo", name: "After Shave Gel", capacity: 60, unit: "ml", price: 18.00, img: "", link: "" },
        { cat: "Solari", name: "Latte Solare 6", capacity: 125, unit: "ml", price: 19.50, img: "", link: "" },
        { cat: "Solari", name: "Latte Solare Spray 15", capacity: 200, unit: "ml", price: 31.50, img: "", link: "" },
        { cat: "Solari", name: "Latte Solare 30", capacity: 250, unit: "ml", price: 31.50, img: "", link: "" },
        { cat: "Solari", name: "Crema Viso Solare 30", capacity: 50, unit: "ml", price: 28.50, img: "", link: "" },
        { cat: "Solari", name: "Latte Solare 50", capacity: 125, unit: "ml", price: 29.50, img: "", link: "" },
        { cat: "Solari", name: "Gel Doposole", capacity: 250, unit: "ml", price: 31.50, img: "", link: "" },
        { cat: "Infiore", name: "Crema 24h Rimpolpante", capacity: 50, unit: "ml", price: 59.00, img: "", link: "" },
        { cat: "Infiore", name: "Crema Giorno Rigenerante", capacity: 50, unit: "ml", price: 53.00, img: "", link: "" },
        { cat: "Infiore", name: "Crema Notte Rigenerante", capacity: 50, unit: "ml", price: 53.00, img: "", link: "" },
        { cat: "Infiore", name: "Crema Contorno Occhi", capacity: 30, unit: "ml", price: 50.00, img: "", link: "" },
        { cat: "Infiore", name: "Siero Ultra-Rigenerante", capacity: 30, unit: "ml", price: 53.00, img: "", link: "" },
        { cat: "Infiore", name: "Crema Detergente", capacity: 125, unit: "ml", price: 30.50, img: "", link: "" },
        { cat: "Infiore", name: "Gel Detergente", capacity: 125, unit: "ml", price: 30.50, img: "", link: "" },
        { cat: "Infiore", name: "Peeling", capacity: 50, unit: "ml", price: 37.50, img: "", link: "" },
        { cat: "Infiore", name: "Maschera Gel Rassodante", capacity: 75, unit: "ml", price: 39.50, img: "", link: "" },
        { cat: "Infiore", name: "Idrogel Ultra-Idratante", capacity: 50, unit: "ml", price: 39.50, img: "", link: "" },
        { cat: "Infiore", name: "Struccante Micellare", capacity: 150, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Infiore", name: "Tonico Vitalizzante", capacity: 150, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Infiore", name: "Latte Corpo Vellutante", capacity: 200, unit: "ml", price: 29.00, img: "", link: "" },
        { cat: "Capelli", name: "Shampoo Addolcente", capacity: 250, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Capelli", name: "Shampoo Rigenerante", capacity: 250, unit: "ml", price: 25.00, img: "", link: "" },
        { cat: "Capelli", name: "Shampoo Purificante", capacity: 250, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Capelli", name: "Shampoo Antiforfora", capacity: 250, unit: "ml", price: 23.00, img: "", link: "" },
        { cat: "Capelli", name: "Shampoo Ravvivante", capacity: 250, unit: "ml", price: 24.00, img: "", link: "" },
        { cat: "Capelli", name: "Shampoo Tea Tree", capacity: 250, unit: "ml", price: 29.00, img: "", link: "" },
        { cat: "Capelli", name: "Shampoo Volumizzante", capacity: 250, unit: "ml", price: 26.00, img: "", link: "" },
        { cat: "Capelli", name: "Balsamo Disciplinante", capacity: 150, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Capelli", name: "Lozione Anticaduta", capacity: 75, unit: "ml", price: 32.50, img: "", link: "" },
        { cat: "Capelli", name: "Latte Spray Riparatore", capacity: 120, unit: "ml", price: 26.00, img: "", link: "" },
        { cat: "Integrazione Alimentare", name: "+Energy", capacity: 60, unit: "gr", price: 34.50, img: "", link: "" },
        { cat: "Amici Animali", name: "Shampoo Cani e Gatti", capacity: 200, unit: "ml", price: 18.00, img: "", link: "" },
        { cat: "Casa", name: "Detergente NR Plus", capacity: 1000, unit: "ml", price: 22.00, img: "", link: "" },
        { cat: "Casa", name: "Spray Lavanda", capacity: 115, unit: "ml", price: 31.50, img: "", link: "" },
        { cat: "Casa", name: "Spray Ambientale", capacity: 200, unit: "ml", price: 21.00, img: "", link: "" },
        { cat: "Casa", name: "Smacchiatore Pretrattante", capacity: 75, unit: "ml", price: 13.00, img: "", link: "" },
        { cat: "Casa", name: "Cura Legno", capacity: 200, unit: "ml", price: 22.00, img: "", link: "" }
    ].map((p, i) => ({ ...p, id: i + 1 }));

    createApp({
        data() {
            return {
                currentSection: 'splash',
                searchQuery: '',
                newItemSearch: '',
                products: [],
                inventory: [],
                historyLogs: [],
                
                // Gestione Carico (Multi-row)
                showAddModal: false,
                selectedProd: null,
                addBatches: [{ qty: 1, expiry: '' }], 
                
                // Gestione Scarico
                showSellModal: false,
                sellData: { item: null, batchIndex: null, maxQty: 1, selectedQty: 1, itemName: '', expiry: '' },

                // Modifica Batch
                editBatchData: null,

                expandedItem: null,
                
                // Gestione Prodotto
                editingProduct: null,
                isNewProduct: false,
                resetConfirm: ''
            }
        },
        mounted() {
            const savedProducts = localStorage.getItem('just_products');
            const savedInventory = localStorage.getItem('just_inventory');
            const savedHistory = localStorage.getItem('just_history');

            if (savedProducts) {
                this.products = JSON.parse(savedProducts);
            } else {
                this.products = initialProducts;
                this.saveData();
            }

            if (savedInventory) this.inventory = JSON.parse(savedInventory);
            if (savedHistory) this.historyLogs = JSON.parse(savedHistory);
        },
        computed: {
            filteredProducts() {
                const q = this.searchQuery.toLowerCase();
                const filtered = this.products.filter(p => p.name.toLowerCase().includes(q));
                return filtered.reduce((groups, item) => {
                    const group = (groups[item.cat] || []);
                    group.push(item);
                    groups[item.cat] = group;
                    return groups;
                }, {});
            },
            uniqueCategories() {
                return [...new Set(this.products.map(p => p.cat))].sort();
            },
            filteredAddList() {
                if(!this.newItemSearch) return [];
                const q = this.newItemSearch.toLowerCase();
                return this.products.filter(p => p.name.toLowerCase().includes(q));
            },
            groupedInventory() {
                const grouped = {};
                this.inventory.forEach(batch => {
                    const prod = this.products.find(p => p.id === batch.prodId);
                    if (!prod) return;
                    if (!grouped[prod.cat]) grouped[prod.cat] = [];
                    let itemEntry = grouped[prod.cat].find(i => i.id === prod.id);
                    if (!itemEntry) {
                        itemEntry = { ...prod, batches: [] };
                        grouped[prod.cat].push(itemEntry);
                    }
                    itemEntry.batches.push(batch);
                });
                return grouped;
            },
            totalItemsInStock() {
                return this.inventory.reduce((sum, batch) => sum + batch.qty, 0);
            },
            allBatchesSorted() {
                const list = this.inventory.map(batch => {
                    const prod = this.products.find(p => p.id === batch.prodId);
                    return {
                        ...batch,
                        name: prod ? prod.name : 'Prodotto eliminato',
                        capacity: prod ? prod.capacity : '',
                        unit: prod ? prod.unit : ''
                    };
                }).filter(b => b.name !== 'Prodotto eliminato');
                return list.sort((a, b) => new Date(a.expiry) - new Date(b.expiry));
            }
        },
        methods: {
            enterApp() { this.currentSection = 'Magazzino'; },
            saveData() {
                localStorage.setItem('just_products', JSON.stringify(this.products));
                localStorage.setItem('just_inventory', JSON.stringify(this.inventory));
                localStorage.setItem('just_history', JSON.stringify(this.historyLogs));
            },
            
            // --- GESTIONE ARTICOLI ---
            editProduct(prod) {
                this.isNewProduct = false;
                // Assicura che il campo link esista anche se il prodotto è vecchio
                this.editingProduct = { link: '', ...prod };
            },
            openNewProductModal() {
                this.isNewProduct = true;
                this.editingProduct = { id: Date.now(), name: '', cat: '', capacity: null, unit: 'ml', price: null, img: '', link: '' };
            },
            saveProductEdit() {
                if (!this.editingProduct.name || !this.editingProduct.cat) { alert("Nome e Categoria obbligatori."); return; }
                if (this.isNewProduct) { this.products.push(this.editingProduct); } 
                else {
                    const idx = this.products.findIndex(p => p.id === this.editingProduct.id);
                    if (idx !== -1) this.products[idx] = this.editingProduct;
                }
                this.saveData();
                this.editingProduct = null;
            },
            deleteProduct(prod) {
                if(confirm(`Eliminare "${prod.name}"?`)) {
                    this.products = this.products.filter(p => p.id !== prod.id);
                    this.saveData();
                    this.editingProduct = null;
                }
            },
            imageError(e) { e.target.src = PLACEHOLDER_IMG; },

            // --- CARICO MAGAZZINO (LOGICA MULTI-ROW) ---
            startAddProcess(prod) {
                this.selectedProd = prod;
                this.addBatches = [{ qty: 1, expiry: '' }]; // Reset con una riga vuota
            },
            addBatchRow() {
                this.addBatches.push({ qty: 1, expiry: '' });
            },
            removeBatchRow(index) {
                this.addBatches.splice(index, 1);
            },
            closeAddModal() {
                this.showAddModal = false;
                this.selectedProd = null;
                this.addBatches = [{ qty: 1, expiry: '' }];
                this.newItemSearch = '';
            },
            confirmAdd() {
                for (let batch of this.addBatches) {
                    if (!batch.expiry) { alert('Inserisci la data di scadenza per tutte le righe.'); return; }
                }
                this.addBatches.forEach(batch => {
                    this.inventory.push({
                        prodId: this.selectedProd.id,
                        qty: batch.qty,
                        expiry: batch.expiry,
                        dateAdded: new Date().toISOString()
                    });
                    this.logHistory(this.selectedProd.name, batch.qty, 'IN');
                });
                this.saveData();
                this.closeAddModal();
                alert("Carico completato!");
            },

            // --- SCARICO (VENDITA) CON CONFERMA ---
            openSellModal(item, batchIndex) {
                const batch = item.batches[batchIndex];
                this.sellData = {
                    item: item,
                    batchIndex: batchIndex,
                    maxQty: batch.qty,
                    selectedQty: 1,
                    itemName: item.name,
                    expiry: batch.expiry
                };
                this.showSellModal = true;
            },
            confirmSell() {
                const item = this.sellData.item;
                const batch = item.batches[this.sellData.batchIndex];
                const qtyToSell = this.sellData.selectedQty;

                batch.qty -= qtyToSell;
                if (batch.qty === 0) {
                    const realIndex = this.inventory.indexOf(batch);
                    if (realIndex > -1) this.inventory.splice(realIndex, 1);
                }

                this.logHistory(item.name, qtyToSell, 'OUT');
                this.saveData();
                this.showSellModal = false;
            },

            // --- MODIFICA BATCH ESISTENTE ---
            openEditBatchModal(item, batchIndex) {
                const batch = item.batches[batchIndex];
                this.editBatchData = {
                    originalBatch: batch, 
                    qty: batch.qty,
                    expiry: batch.expiry
                };
            },
            saveBatchEdit() {
                if(!this.editBatchData.expiry) { alert("Data scadenza obbligatoria"); return; }
                this.editBatchData.originalBatch.qty = this.editBatchData.qty;
                this.editBatchData.originalBatch.expiry = this.editBatchData.expiry;
                this.saveData();
                this.editBatchData = null;
            },

            // --- UTILS ---
            toggleExpand(id) { this.expandedItem = this.expandedItem === id ? null : id; },
            getTotalQty(prodId) {
                return this.inventory.filter(b => b.prodId === prodId).reduce((sum, b) => sum + b.qty, 0);
            },
            logHistory(name, qty, type) {
                this.historyLogs.unshift({ id: Date.now(), itemName: name, qty: qty, type: type, date: new Date().toISOString(), note: '' });
            },
            saveHistory() { localStorage.setItem('just_history', JSON.stringify(this.historyLogs)); },
            formatDate(dateStr) { if(!dateStr) return 'N/A'; return new Date(dateStr).toLocaleDateString('it-IT', { year: '2-digit', month: '2-digit', day: '2-digit' }); },
            formatDateTime(isoStr) { return new Date(isoStr).toLocaleString('it-IT', { dateStyle: 'short', timeStyle: 'short' }); },
            getDaysRemaining(expiry) {
                if(!expiry) return '';
                const today = new Date(); today.setHours(0,0,0,0);
                const expDate = new Date(expiry); expDate.setHours(0,0,0,0);
                const days = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
                if (days < 0) return "SCADUTO"; if (days === 0) return "Scade oggi";
                return `${days} giorni`;
            },
            getExpiryColor(expiry) {
                const days = this.getDaysDiff(expiry);
                if (days < 0) return 'text-red-700 font-bold';
                if (days < 30) return 'text-orange-500 font-bold';
                return 'text-green-600';
            },
            getExpiryBorderColor(expiry) {
                const days = this.getDaysDiff(expiry);
                if (days < 0) return 'border-red-500 bg-red-50';
                if (days < 60) return 'border-yellow-400 bg-yellow-50';
                return 'border-green-500 border-l-[6px]';
            },
            getDaysDiff(expiry) {
                const today = new Date(); today.setHours(0,0,0,0);
                const expDate = new Date(expiry); expDate.setHours(0,0,0,0);
                return Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
            },
            exportToExcel() {
                const wb = XLSX.utils.book_new();
                const articoliData = this.products.map(p => ({ Categoria: p.cat, Nome: p.name, 'Capacità': p.capacity, 'Unità': p.unit, 'Prezzo (€)': p.price }));
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(articoliData), "Articoli");
                const magazzinoData = this.inventory.map(i => { const p = this.products.find(x => x.id === i.prodId); return { Categoria: p?.cat, Prodotto: p?.name, 'Qta': i.qty, 'Scadenza': this.formatDate(i.expiry) }; });
                XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(magazzinoData), "Magazzino");
                XLSX.writeFile(wb, "Just_Magazzino_Export.xlsx");
            },
            backupData() {
                const data = { products: this.products, inventory: this.inventory, history: this.historyLogs };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `just_backup.json`; a.click();
            },
            restoreData(e) {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try { const data = JSON.parse(e.target.result); this.products = data.products; this.inventory = data.inventory; this.historyLogs = data.history; this.saveData(); location.reload(); } catch(err) { alert("File non valido."); }
                }; reader.readAsText(file);
            },
            factoryReset() { if(confirm("Cancellare TUTTO?")) { localStorage.clear(); location.reload(); } }
        }
    }).mount('#app');
</script>
</body>
</html>
